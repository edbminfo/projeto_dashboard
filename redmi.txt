üìä Dashboard Multi-Tenant com Sincroniza√ß√£o em Tempo Real
Este projeto √© uma solu√ß√£o completa de Business Intelligence (BI) para redes de lojas. Ele permite extrair dados de bancos de dados locais (Firebird ou PostgreSQL), sincroniz√°-los com uma nuvem centralizada e visualizar m√©tricas em um dashboard web seguro e multi-empresas.

üèóÔ∏è Arquitetura do Sistema
O sistema √© dividido em tr√™s grandes blocos:

Server API (Python/FastAPI): O "c√©rebro" que gerencia os dados, cria os bancos de dados para cada cliente (Schemas) e fornece os relat√≥rios.

Web Front (Node.js/Express): A interface visual onde o usu√°rio faz login e v√™ os gr√°ficos.

Client Sync (Python): O agente que fica instalado no computador da loja, enviando dados para a API.

1. üêç Backend (API Server)
Localiza√ß√£o: /server

Respons√°vel por receber os dados e gerenciar a seguran√ßa e a estrutura do banco de dados (PostgreSQL).

üìÇ Arquivos e Fun√ß√µes Principais:
main.py

Ponto de entrada da aplica√ß√£o.

Inicializa a tabela mestre (lojas_sincronizadas).

Define as rotas da API e configura o CORS para permitir acesso do Frontend.

routers/admin.py (Gest√£o de Tenants)

Fun√ß√£o criar_cliente: A m√°gica acontece aqui. Quando voc√™ cadastra um novo cliente, ele:

Gera um Token de API √∫nico.

Cria um Schema exclusivo no PostgreSQL (ex: tenant_123456).

Cria o usu√°rio administrador para acesso ao dashboard.

Fun√ß√£o listar_lojas: Retorna todas as lojas cadastradas para o painel administrativo.

routers/sync.py (Sincroniza√ß√£o)

Fun√ß√£o upsert_generico: Uma fun√ß√£o inteligente que recebe dados JSON e cria/atualiza tabelas automaticamente. Se o cliente enviar uma coluna nova (ex: cor_produto), o sistema altera a tabela no banco sozinho, sem precisar parar o servidor.

Fun√ß√£o deletar_venda: Processa a exclus√£o de vendas em cascata (remove Venda, Itens e Pagamentos) para manter o relat√≥rio limpo.

routers/reports.py (Relat√≥rios)

Calcula os KPIs em tempo real (Faturamento, Ticket M√©dio, CMV, Margem).

Converte os dados de texto (padr√£o do sync) para n√∫meros (::numeric) para garantir c√°lculos matem√°ticos corretos.

security.py

Intercepta cada requisi√ß√£o, l√™ o Token Bearer e descobre automaticamente qual Schema do banco de dados aquele cliente deve acessar. Garante que os dados de uma loja nunca se misturem com os de outra.

2. üåê Frontend (Web Dashboard)
Localiza√ß√£o: /web-front

Interface visual desenvolvida em Node.js com EJS para renderiza√ß√£o server-side.

üìÇ Arquivos e Fun√ß√µes Principais:
server.js

Autentica√ß√£o via WhatsApp/SMS: O sistema n√£o usa senha. O usu√°rio digita o telefone, o sistema gera um c√≥digo, envia via Webhook (n8n) e valida o acesso.

Gest√£o de Sess√£o: Mant√©m o usu√°rio logado por 30 dias.

Sele√ß√£o de Loja: Se o usu√°rio √© dono de 5 lojas, o sistema lista todas e permite alternar entre elas.

Renderiza√ß√£o: Consulta o banco PostgreSQL (usando pg) e injeta os dados nas views HTML.

views/painel.ejs

O dashboard principal. Exibe os "Cards" (Faturamento, Lucro, etc.) e filtros de data.

Usa Bootstrap 5 para ser responsivo (funciona no celular e PC).

views/login.ejs & verificar.ejs

Telas de entrada com design moderno e feedback visual de erro/sucesso.

3. üñ•Ô∏è Agente Local (Client Sync)
Localiza√ß√£o: /client

Script em Python que roda no servidor da loja (Windows/Linux). Ele l√™ o banco local (Firebird/Postgres) e envia para a nuvem.

üìÇ Arquivos e Fun√ß√µes Principais:
agente_sync.py

Instala√ß√£o Autom√°tica: Na primeira execu√ß√£o, ele conecta no banco da loja, cria a coluna de controle SYNC_DASH e instala Triggers.

Monitoramento: As Triggers marcam qualquer altera√ß√£o (nova venda, mudan√ßa de pre√ßo) com SYNC_DASH = 'N'.

Ciclo de Envio:

L√™ registros pendentes (SYNC_DASH = 'N').

Envia em lotes (configur√°vel, padr√£o 20) para a API.

Se sucesso, marca como SYNC_DASH = 'S'.

Gest√£o de Delay (Anti-Overload):

Modo Ativo: Espera 2s entre lotes para n√£o travar o servidor.

Modo Ocioso: Se n√£o tiver nada para enviar, dorme 30s para economizar recursos.

Dele√ß√£o: Verifica se vendas foram canceladas/exclu√≠das localmente e envia o comando de exclus√£o para a nuvem.

config.ini

Arquivo onde o cliente define o token da loja, o caminho do banco de dados e ajustes de performance.

üöÄ Como Rodar
Servidor (Docker)
Para subir o Backend e o Frontend juntos:

Bash
cd server
docker-compose up --build -d
Frontend: http://localhost:3000

Backend API: http://localhost:8000

Banco: Porta 5411

Cliente (Sync)
No computador da loja (requer Python 3.10+):

Configure o config.ini com o Token da loja.

Instale as depend√™ncias:

Bash
pip install -r requirements.txt
Execute o agente:

Bash
python agente_sync.py
üõ†Ô∏è Tecnologias Utilizadas
Linguagens: Python 3.10, JavaScript (Node.js 18).

Frameworks: FastAPI (Python), Express (Node.js).

Banco de Dados: PostgreSQL 15 (Nuvem), Firebird/PostgreSQL (Local).

Containeriza√ß√£o: Docker & Docker Compose.

Frontend: EJS, Bootstrap 5.